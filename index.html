<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mapa de Escuelas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="theme-color" content="#000000">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="stylesheet" href="leaflet.css" />
  <link rel="stylesheet" href="style.css" />
    <style>
    #qrShareOverlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.6);
      z-index: 3000;
    }
    #qrShareInner {
      background: #fff;
      border-radius: 12px;
      padding: 16px 18px 12px 18px;
      max-width: 90vw;
      text-align: center;
      box-shadow: 0 4px 18px rgba(0,0,0,0.35);
    }
    #qrShareInner h3 {
      margin: 0 0 8px 0;
      font-size: 18px;
    }
    #qrShareInner p {
      margin: 0 0 10px 0;
      font-size: 13px;
    }
    #qrShareCanvas {
      width: 180px;
      height: 180px;
      margin-bottom: 10px;
    }
    #qrShareCloseBtn {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 9999px;
      border: none;
      background: #222;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      font-size: 13px;
    }
  </style>
  <script>
    if("serviceWorker" in navigator){
      window.addEventListener("load",function(){
        try{
          navigator.serviceWorker.register("service-worker.js");
        }catch(e){}
      });
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    (function(){
      var l = document.querySelector('link[href="style.css"]');
      if (l) { l.href = 'style.css?v=' + Date.now(); }
    })();
    window.wirePopupInteractions = function(root,p,isOverlay){
      if(!root) return;
      var frame=root.querySelector('.popup-frame');
      var imgEl=root.querySelector('.frame-img');
      if(frame && imgEl){
        imgEl.onerror=function(){ try{ imgEl.remove(); }catch(e){} };
        if(window.getFrameURL){
          window.getFrameURL().then(function(url){ if(url) imgEl.src=url; });
        }
      }
      var dlBtn=root.querySelector('.popup-dl-btn');
      if(dlBtn){
        dlBtn.onclick = async function(ev){
          ev.stopPropagation();
          var targetFrame=root.querySelector('.popup-frame');
          if(!targetFrame || typeof html2canvas==='undefined') return;
          var fc=targetFrame.querySelector('.frame-content');
          if(!fc) return;
          var isMobile=((window.innerWidth||1024)<=600)||(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent));
          var scaleVal=isMobile?1.25:2;
          var visibleCanvas=await html2canvas(targetFrame,{ backgroundColor:null, useCORS:true, scale:scaleVal });
          var piz=new Image();
          piz.onload=function(){
            var width=piz.width;
            var height=piz.height;
            var finalCanvas=document.createElement('canvas');
            finalCanvas.width=width;
            finalCanvas.height=height;
            var ctx=finalCanvas.getContext('2d');
            ctx.drawImage(piz,0,0,width,height);
            ctx.drawImage(visibleCanvas,0,0,width,height);
            var fname=String(p.nombre||'escuela').replace(/[^a-z0-9 -]/gi,'_');
            if(!fname) fname='escuela';
            fname+='.jpg';
            finalCanvas.toBlob(function(blob){
              if(!blob) return;
              var url=URL.createObjectURL(blob);
              var proto=(window.location&&window.location.protocol)||'';
              var isHttps=proto.indexOf('https')===0;
              var ua=(navigator&&navigator.userAgent)||'';
              var isMobileDevice=/Android|iPhone|iPad|iPod/i.test(ua);
              if(isHttps && isMobileDevice){
                alert('Se abrir√° la imagen; usa Guardar imagen desde el navegador.');
                window.location.href=url;
              } else {
                var a=document.createElement('a');
                a.href=url;
                a.download=fname;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                alert('Imagen descargada: '+fname);
              }
              URL.revokeObjectURL(url);
            },'image/jpeg',0.92);
          };
          piz.onerror=function(){
            var ancho=visibleCanvas.width;
            var alto=visibleCanvas.height;
            var finalCanvas=document.createElement('canvas');
            finalCanvas.width=ancho;
            finalCanvas.height=alto;
            var ctx=finalCanvas.getContext('2d');
            ctx.drawImage(visibleCanvas,0,0,ancho,alto);
            var fname=String(p.nombre||'escuela').replace(/[^a-z0-9 -]/gi,'_')+'.jpg';
            finalCanvas.toBlob(function(blob){
              if(!blob) return;
              var url=URL.createObjectURL(blob);
              var proto=(window.location&&window.location.protocol)||'';
              var isHttps=proto.indexOf('https')===0;
              var ua=(navigator&&navigator.userAgent)||'';
              var isMobileDevice=/Android|iPhone|iPad|iPod/i.test(ua);
              if(isHttps && isMobileDevice){
                alert('Se abrir√° la imagen; usa Guardar imagen desde el navegador.');
                window.location.href=url;
              } else {
                var a=document.createElement('a');
                a.href=url;
                a.download=fname;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                alert('Imagen descargada: '+fname);
              }
              URL.revokeObjectURL(url);
            },'image/jpeg',0.92);
          };
          piz.src=(targetFrame.querySelector('.frame-img') && targetFrame.querySelector('.frame-img').src) || 'pizarron.png';
        };
      }
      var mapBtn=root.querySelector('.popup-map-capture-btn');
      if(mapBtn){
        try{ mapBtn.parentNode.removeChild(mapBtn); }catch(e){}
      }
      var volverBtn=root.querySelector('.popup-volver-btn');
      if(volverBtn){
        volverBtn.onclick=function(ev){
          ev.stopPropagation();
          if(isOverlay){ hideSchoolOverlay(); } else { map.closePopup(); }
        };
      }
    };
  </script>
  <style>
    @font-face { font-family: 'CooperBlackCustom'; src: url('CooperBlackCustom.otf') format('opentype'); font-weight: normal; font-style: normal; }
    @font-face { font-family: 'CalibriCustom'; src: url('CalibriCustom.TTF') format('truetype'); font-weight: normal; font-style: normal; }
    
    html, body { margin:0; height:100%; overflow:hidden; color-scheme: only light; font-family: 'CalibriCustom', Arial, sans-serif; }
    #splash { background:#000; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; position:fixed; top:0; left:0; width:100%; }
    .circle-bounce { width: 300px; height: 300px; background:#fff; border-radius:50%; box-shadow: 0 0 40px 8px #fff8, 0 8px 32px #0006; display:flex; flex-direction:column; align-items:center; justify-content:center; margin-bottom:40px; animation: bounce 1.6s infinite cubic-bezier(.5,0,.5,1); position: relative; animation-duration: 5s; user-select: none; }
    @keyframes bounce { 0%{ transform: translateY(0);} 20%{ transform: translateY(-36px);} 40%{ transform: translateY(0);} 60%{ transform: translateY(-22px);} 80%{ transform: translateY(0);} 100%{ transform: translateY(0);} }
    .la-raiz { font-size:3em; color:#222; letter-spacing:2px; font-weight:bold; font-family:'CooperBlackCustom','Cooper Black', serif; }
    .agrupacion { font-size:1.5em; color:#222; font-weight:bold; margin-top:8px; font-family:'CalibriCustom', Arial, sans-serif; }
    .splash-title { font-size:2.2em; color:#fff; font-weight:bold; letter-spacing:1px; margin-bottom:12px; text-align:center; position:fixed; top:65%; left:50%; transform:translateX(-50%); width:90%; max-width:600px; }
.splash-subtitle { font-size:1.3em; color:#fff; margin-bottom:18px; text-align:center; position:fixed; top:70%; left:50%; transform:translateX(-50%); width:90%; max-width:600px; }
    .splash-btn { background:#fff; color:#222; font-size:1.1em; font-weight:bold; border:none; border-radius:16px; padding:12px 32px; cursor:pointer; letter-spacing:2px; transition: box-shadow 0.3s ease, background-color 0.3s ease; animation: pulseSoft 2.2s infinite; }
     .splash-texts-container { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:15; }
      #splash { z-index:5; }
      #flagContainer { z-index:20; }
      .splash-texts-container .splash-title { position:absolute; top:68%; left:50%; transform:translateX(-50%); font-size:2.2em; color:#fff; font-weight:bold; letter-spacing:1px; text-align:center; width:90%; max-width:600px; pointer-events:auto; margin-bottom:25px; }
      .splash-texts-container .splash-subtitle { position:absolute; top:75%; left:50%; transform:translateX(-50%); font-size:1.3em; color:#fff; text-align:center; width:auto; max-width:80%; pointer-events:auto; line-height:1.2; white-space:nowrap; }
      .btn-container { position:absolute; bottom:12%; left:50%; transform:translateX(-50%); width:260px; pointer-events:auto; }
      .btn-container .splash-btn + .splash-btn { margin-top:12px; }
      .splash-texts-container .splash-btn { width:100%; background:#fff; color:#222; font-size:1.0em; font-weight:bold; border:none; border-radius:25px; padding:16px 15px; cursor:pointer; letter-spacing:1px; transition: all 0.3s ease; animation: pulseButton 2.2s infinite; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; position: relative; box-shadow: 0 0 0 rgba(255,255,255,0.3) inset; }
      .splash-texts-container #startBtn { box-shadow: 0 0 24px rgba(255,255,255,0.5) inset, 0 8px 28px rgba(0,0,0,0.35); }
      .splash-texts-container #splashShareBtn { font-size:0.9em; padding:12px 12px; opacity:0.92; }
    .splash-texts-container .splash-btn::before { content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px; background: linear-gradient(45deg, #ffffff, #f0f0f0, #ffffff); border-radius: 27px; z-index: -1; opacity: 0; transition: opacity 0.3s ease; }
      .splash-texts-container .splash-btn:hover::before { opacity: 1; }
      .splash-texts-container .splash-btn:hover { box-shadow: 0 0 20px rgba(255,255,255,0.4) inset, 0 6px 25px rgba(0,0,0,0.2); }
      .splash-version-tag {
        position:fixed;
        top:5%;
        left:50%;
        transform:translateX(-50%);
        font-size:0.85em;
        color:rgba(255,255,255,0.95);
        text-align:center;
        max-width:90%;
        pointer-events:none;
        z-index:2100;
        text-shadow:0 2px 4px rgba(0,0,0,0.6);
      }
    .bus-route-label{
      font-size:9px;
      padding:1px 3px;
      background-color:rgba(255,255,255,0.78);
      border:1px solid rgba(0,0,0,0.25);
      border-radius:2px;
      box-shadow:none;
      pointer-events:none;
    }
    .school-name-label{
      font-size:11px;
      font-weight:bold;
      padding:1px 4px;
      background-color:rgba(255,255,255,0.9);
      border:1px solid rgba(0,0,0,0.35);
      border-radius:3px;
      pointer-events:none;
    }
    .map-capture-mode .leaflet-popup{
      display:none !important;
    }
    @keyframes pulseSoft { 0%{ box-shadow: 0 2px 8px rgba(0,0,0,0.15); } 50%{ box-shadow: 0 6px 20px rgba(0,0,0,0.25); background-color: #ffffff; } 100%{ box-shadow: 0 2px 8px rgba(0,0,0,0.15); } }
     @keyframes pulse { 0%{ box-shadow: 0 1px 1px 0 #fff0, 0 1px 1px #0001;} 50%{ box-shadow: 0 4px 8px 0 #fff0, 0 4px 8px #2222;} 100%{ box-shadow: 0 1px 1px 0 #fff0, 0 1px 1px #0001;} }
    #mainApp { display:none; height:100%; position:fixed; top:0; left:0; width:100%; }

    #flagContainer { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 380px; height: 250px; z-index: 2001; display: none; cursor: pointer; overflow: visible; }
    #flagPoleLeft, #flagPoleRight { position: absolute; bottom: -200px; width: 10px; height: 450px; background: linear-gradient(to right, #8B4513, #A0522D, #8B4513); border-radius: 5px; box-shadow: 2px 0 6px rgba(0,0,0,0.3); }
    #flagPoleLeft { left: 15px; }
    #flagPoleRight { right: 15px; }
    #flagFabric { 
      position: absolute; 
      top: 0px; 
      left: 30px; 
      width: calc(100% - 60px); /* Ancho fijo: contenedor menos 30px de cada lado */
      max-width: 320px; /* M√°ximo ancho para que quepa entre las ca√±as */
      box-sizing: border-box; /* Incluir padding y border en el ancho total */
      height: 150px; 
      background: 
        /* Textura r√∫stica simplificada */
        radial-gradient(ellipse at 20% 30%, rgba(230, 230, 230, 0.4) 3px, transparent 5px),
        radial-gradient(ellipse at 80% 20%, rgba(220, 220, 220, 0.3) 2px, transparent 4px),
        radial-gradient(ellipse at 60% 80%, rgba(240, 240, 240, 0.2) 2px, transparent 3px),
        /* Base tela r√∫stica */
        linear-gradient(135deg, #f0f0f0 0%, #e5e5e5 25%, #f5f5f5 50%, #ebebeb 75%, #f2f2f2 100%);
      background-size: 30px 25px, 25px 30px, 35px 40px, 100% 100%;
      border-radius: 8px; 
      box-shadow: 0 6px 20px rgba(0,0,0,0.3), inset 0 0 15px rgba(0,0,0,0.02);
      overflow: visible;
      filter: contrast(1.05) brightness(1.0);
      transform-style: preserve-3d;
      position: relative;
    }
    #flagFabric::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        /* Textura r√∫stica ligera */
        radial-gradient(ellipse at 30% 25%, rgba(235,235,235,0.2) 2px, transparent 3px),
        radial-gradient(ellipse at 70% 75%, rgba(225,225,225,0.15) 1px, transparent 2px);
      opacity: 0.4;
      pointer-events: none;
    }
    #flagFabric::after {
      display: none;
    }

    #flagText { 
      position: absolute; 
      top: 20px; 
      left: 0; 
      right: 0; 
      text-align: center; 
      font-family: 'CooperBlackCustom', 'Cooper Black', serif; 
      font-size: 2.8em; 
      color: black; 
      font-weight: normal; 
      letter-spacing: 1px; 
      text-shadow: 0 2px 4px rgba(0,0,0,0.1); 
      animation: flagTextWave 3s ease-in-out infinite; 
      transform-origin: center center;
    }
    @keyframes flagTextWave {
      0% { transform: rotateY(0deg) translateX(0px) translateY(0px); }
      10% { transform: rotateY(1.5deg) translateX(1px) translateY(-0.5px); }
      20% { transform: rotateY(4deg) translateX(2.5px) translateY(-1px); }
      30% { transform: rotateY(6deg) translateX(4px) translateY(-0.5px); }
      40% { transform: rotateY(7.5deg) translateX(5px) translateY(0px); }
      50% { transform: rotateY(6deg) translateX(4px) translateY(0.5px); }
      60% { transform: rotateY(3deg) translateX(2px) translateY(1px); }
      70% { transform: rotateY(-1deg) translateX(-0.5px) translateY(0.5px); }
      80% { transform: rotateY(-4deg) translateX(-2px) translateY(0px); }
      90% { transform: rotateY(-2.5deg) translateX(-1px) translateY(-0.5px); }
      100% { transform: rotateY(0deg) translateX(0px) translateY(0px); }
    }

    @keyframes flagWaveHorizontal {
      0% {
        transform: rotateY(0deg) skewX(0deg);
        filter: brightness(1);
      }
      10% {
        transform: rotateY(3deg) skewX(1deg);
        filter: brightness(1.02);
      }
      20% {
        transform: rotateY(8deg) skewX(2deg);
        filter: brightness(1.04);
      }
      30% {
        transform: rotateY(12deg) skewX(3deg);
        filter: brightness(1.06);
      }
      40% {
        transform: rotateY(15deg) skewX(2deg);
        filter: brightness(1.05);
      }
      50% {
        transform: rotateY(12deg) skewX(1deg);
        filter: brightness(1.03);
      }
      60% {
        transform: rotateY(6deg) skewX(0.5deg);
        filter: brightness(1.01);
      }
      70% {
        transform: rotateY(-2deg) skewX(-0.5deg);
        filter: brightness(1);
      }
      80% {
        transform: rotateY(-8deg) skewX(-1deg);
        filter: brightness(1.02);
      }
      90% {
        transform: rotateY(-5deg) skewX(-0.5deg);
        filter: brightness(1.01);
      }
      100% {
        transform: rotateY(0deg) skewX(0deg);
        filter: brightness(1);
      }
    }
    #flagFabric { animation: flagWaveHorizontal 4s ease-in-out infinite; transform-origin: left center; }
    #flagFabric::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 15% 25%, rgba(255,255,255,0.15) 1px, transparent 1px),
        radial-gradient(circle at 85% 75%, rgba(0,0,0,0.08) 1px, transparent 1px),
        radial-gradient(circle at 45% 60%, rgba(255,255,255,0.12) 1px, transparent 1px),
        radial-gradient(circle at 75% 15%, rgba(0,0,0,0.06) 1px, transparent 1px),
        radial-gradient(circle at 25% 85%, rgba(255,255,255,0.09) 1px, transparent 1px),
        linear-gradient(45deg, transparent 48%, rgba(255,255,255,0.03) 49%, rgba(255,255,255,0.03) 51%, transparent 52%),
        linear-gradient(-45deg, transparent 48%, rgba(0,0,0,0.02) 49%, rgba(0,0,0,0.02) 51%, transparent 52%);
      background-size: 20px 20px, 25px 25px, 30px 30px, 18px 18px, 22px 22px, 8px 8px, 8px 8px;
      pointer-events: none;
    }
    @keyframes pulseButton { 0% { transform: scale(1); box-shadow: 0 2px 8px rgba(0,0,0,0.15), 0 0 0 rgba(255,255,255,0); } 50% { transform: scale(1.03); box-shadow: 0 6px 20px rgba(0,0,0,0.25), 0 0 15px rgba(255,255,255,0.4); background-color: #ffffff; } 100% { transform: scale(1); box-shadow: 0 2px 8px rgba(0,0,0,0.15), 0 0 0 rgba(255,255,255,0); } }
    
    /* Estilos responsivos para m√≥vil vertical */
    @media screen and (max-width: 600px) and (orientation: portrait) {
      /* Reducir tama√±o del c√≠rculo principal */
      .circle-bounce { 
        width: 200px; 
        height: 200px; 
        margin-bottom: 20px;
      }
      .la-raiz { font-size: 2em; }
      .agrupacion { font-size: 1.2em; margin-top: 6px; }
      
      /* Ajustar posici√≥n de textos */
       .splash-texts-container .splash-title {
         font-size: 1.6em;
         top: 70%;
         width: 95%;
       }
       .splash-texts-container .splash-subtitle {
         font-size: 1.1em;
         top: 75%;
         max-width: 90%;
       }
      
      /* Ajustar bot√≥n */
       .btn-container {
         bottom: 7%;
         width: 220px;
       }
      .splash-texts-container .splash-btn {
        font-size: 0.9em;
        padding: 12px 10px;
        border-radius: 20px;
      }
      
      /* Ajustar contenedor de la bandera */
      #flagContainer {
        width: 320px;
        height: 200px;
        max-width: 95vw;
      }
      
      /* Ajustar ca√±as para que se vean en m√≥vil */
      #flagPoleLeft, #flagPoleRight {
        height: 350px;
        bottom: -150px;
        width: 8px;
      }
      #flagPoleLeft { left: 15px; }
      #flagPoleRight { right: 15px; }
      
      /* Ajustar bandera */
      #flagFabric {
        left: 25px;
        width: calc(100% - 50px);
        max-width: 250px;
        height: 120px;
      }
      
      /* Ajustar easter egg para que no se superponga */
      #easterEgg {
        font-size: 0.85em;
        max-width: 250px;
        padding: 12px;
        top: 20%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
    }
    
    /* Estilos adicionales para pantallas muy peque√±as */
    @media screen and (max-width: 400px) and (orientation: portrait) {
      .circle-bounce { 
        width: 180px; 
        height: 180px; 
      }
      .la-raiz { font-size: 1.8em; }
      .agrupacion { font-size: 1em; }
      
      .splash-texts-container .splash-title {
         font-size: 1.4em;
         top: 65%;
       }
       .splash-texts-container .splash-subtitle {
         font-size: 1em;
         top: 73%;
       }
      
      .btn-container {
         bottom: 5%;
         width: 200px;
       }
      
      #flagContainer {
        width: 280px;
        height: 180px;
      }
      
      #flagPoleLeft, #flagPoleRight {
        height: 320px;
        bottom: -140px;
      }
      
      #easterEgg {
        font-size: 0.8em;
        max-width: 220px;
        padding: 10px;
        top: 20%;
        transform: translate(-50%, -50%);
      }
    }
  </style>
  <script>
  window.getFrameURL = (function(){
    let cached = null;
    let promise = null;
    function process(src){
      return new Promise(function(resolve, reject){
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = function(){
          const w = img.naturalWidth || img.width;
          const h = img.naturalHeight || img.height;
          const canvas = document.createElement('canvas');
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img,0,0);
          const im = ctx.getImageData(0,0,w,h);
          const d = im.data;
          const thr = 22;
          const mX = Math.round(0.09*w);
          const mY = Math.round(0.11*h);
          for (let y=0; y<h; y++){
            for (let x=0; x<w; x++){
              const idx = (y*w + x) * 4;
              const r = d[idx], g = d[idx+1], b = d[idx+2];
              const edge = Math.min(x, y, w-1-x, h-1-y);
              if (edge < Math.max(mX, mY)){
                const dark = (r+g+b)/3 < thr;
                if (dark){
                  const scale = Math.max(0, Math.min(1, edge / Math.max(mX, mY)));
                  d[idx+3] = Math.round(d[idx+3] * scale);
                }
              }
            }
          }
          ctx.putImageData(im,0,0);
          resolve(canvas.toDataURL('image/png'));
        };
        img.onerror = function(){ reject(new Error('frame error')); };
        img.src = src;
      });
    }
    return async function(){
      if (cached) return cached;
      if (!promise) promise = process('pizarron.png').catch(function(){ return null; });
      cached = await promise;
      return cached;
    };
  })();
  </script>
</head>
<body>
  <div id="splash">
    <div class="circle-bounce">
      <div class="la-raiz">LA RA√çZ</div>
      <div class="agrupacion">Agrupaci√≥n docente</div>
    </div>
  </div>
  <div class="splash-texts-container">
    <div class="splash-title">Mapa de escuelas</div>
    <div class="splash-subtitle">La Plata, Berisso y Ensenada</div>
    <div class="btn-container">
      <button class="splash-btn" id="startBtn" onclick="try{ startApp(); }catch(e){ try{ var s=document.getElementById('splash'); var m=document.getElementById('mainApp'); if(s) s.style.display='none'; if(m) m.style.display='block'; setTimeout(function(){ try{ map.invalidateSize(); }catch(_){ } }, 200); }catch(_){ } }"><span>Realice su consulta</span></button>
      <button class="splash-btn" id="splashShareBtn" type="button"><span>‚§¥ Compartir aplicaci√≥n</span></button>
    </div>
    <div class="splash-version-tag">
      Versi√≥n MapaLaRaiz PWA ‚Äì 2026-02-23 09:00 (AR)
    </div>
  </div>
  <div id="qrShareOverlay">
    <div id="qrShareInner">
      <h3>Compartir aplicaci√≥n</h3>
      <p>Escane√° este c√≥digo QR con otro m√≥vil para abrir el mapa.</p>
      <img id="qrShareImg" width="180" height="180" alt="C√≥digo QR para abrir la aplicaci√≥n">
      <div style="margin-top:10px;display:flex;flex-direction:column;gap:6px;align-items:center;">
        <button id="qrShareNativeBtn" type="button" style="padding:4px 12px;border-radius:9999px;border:none;background:#005bbb;color:#fff;font-weight:600;font-size:13px;cursor:pointer;">
          Compartir con otras apps
        </button>
        <button id="qrShareCloseBtn" type="button" style="padding:4px 12px;border-radius:9999px;border:none;background:#222;color:#fff;font-weight:600;font-size:13px;cursor:pointer;">
          Cerrar
        </button>
      </div>
    </div>
  </div>
    <div id="easterEgg" style="display:none;position:fixed;top:20%;left:50%;transform:translate(-50%,-50%);width:200px;height:200px;background:#fff;border-radius:50%;box-shadow:0 0 40px 8px #fff8, 0 8px 32px #0006;z-index:2000;align-items:center;justify-content:center;color:#222;pointer-events:none;overflow:hidden;">
      <div style="display:grid;place-items:center;box-sizing:border-box;width:92%;height:92%;padding:0 8px;text-align:center;font-weight:bold;font-size:1.2em;letter-spacing:0.6px;gap:6px;line-height:1.2;color:#d0002a;text-shadow:0 2px 10px rgba(0,0,0,0.25),0 1px 4px rgba(255,255,255,0.6);">
        <div style="display:flex;align-items:center;justify-content:center;gap:10px;">
          <span>üòä</span>
          <div style="display:flex;flex-direction:column;align-items:center;gap:2px;">
            <span>Creado</span>
            <span>por Emanuel Alvarez</span>
          </div>
          <span>ü§™</span>
        </div>
      </div>
    </div>
      <div id="flagContainer">
        <div id="flagPoleLeft"></div>
        <div id="flagPoleRight"></div>
        <div id="flagFabric">
          <div id="flagText">La Ra√≠z</div>
        </div>

      </div>
  </div>
  <div id="mainApp">
    <div id="topbar">
      <button id="filtersBtn" class="menu-btn" title="Mostrar/ocultar filtros">VER MEN√ö</button>
      <div id="brand-raiz">La Ra√≠z</div>
      <div id="brandBadge"></div>
    </div>
    <div id="admin-panel" style="display:none">
      <div id="filtersHeader"></div>
      <div id="filtersPanel">
        <div class="search-wrap">
          <input id="searchInput" type="text" placeholder="Buscar por nombre, clave, cueanexo">
          <button id="clearSearchBtn" type="button" title="Limpiar b√∫squeda">‚úï</button>
        </div>
        <select id="filterDistrito">
          <option value="">Todos los distritos</option>
          <option value="La Plata">La Plata</option>
          <option value="Berisso">Berisso</option>
          <option value="Ensenada">Ensenada</option>
        </select>
        <select id="filterLocalidad" style="display:none"></select>
        <div id="counterWrap">
          <button id="toggleBoundariesVisibilityBtn" title="Mostrar/ocultar l√≠mites">‚ó´</button>
          <span id="counter" title="Cantidad de resultados">0</span>
        </div>
        <button id="toggleBusRoutesBtn" title="Mostrar/ocultar recorridos de colectivos">üöå</button>
        <button id="togglePoiBtn" title="Mostrar/ocultar lugares de inter√©s docente">üèõ</button>
        <select id="busRouteSelect" style="display:none"></select>
        <button id="geojsonEditModeBtn" title="Modo edici√≥n GeoJSON">‚§°</button>
      </div>
      <div id="filterLevelPanel" class="panel-flotante collapsed">
        <div id="panelHeader">
          <button id="togglePanelBtn">‚ò∞ Niveles</button>
          <span class="panel-hint">
            <span class="panel-hint-arrow">‚¨Ö</span>
            <span class="panel-hint-text">
              <span class="panel-hint-line">Seleccionar</span>
              <span class="panel-hint-line">nivel</span>
            </span>
          </span>
        </div>
        <div id="panelContent" class="hidden"></div>
        <div id="panelResizer" title="Redimensionar panel">‚á≤</div>
      </div>
    </div>
    <div id="map"></div>
  </div>
  <div id="schoolOverlay"><div id="schoolOverlayInner"></div></div>
  <script src="leaflet.js?v=15"></script>
  <script>
    var map = null;
    var allSchools = [];
    var markers = [];
    var poiFeatures = [];
    var poiMarkers = [];
    var municipioGeomByName = {};
    var boundaryLayers = [];
    var localityBoundariesLoaded = false;
    var busRoutesLayer = null;
    var busRoutesHighlightLayer = null;
    var busRoutesVisible = false;
    var busRoutesDataLoaded = false;
    var busRoutesAllFeatures = [];
    var busRouteKeys = [];
    var busRouteKeySamples = {};
    var poiVisible = false;
    function isMobilePortrait(){ var w=window.innerWidth||0,h=window.innerHeight||0; return w<=600 && h>=w; }
    function onPopupOpenCommon(){ try{ var w=window.innerWidth||1024; if(w<=600){ var admin=document.getElementById('admin-panel'); if(admin && window.adminPanelOpen){ window.adminPanelOpen=false; admin.style.display='none'; } } }catch(e){} }
    function hideSchoolOverlay(){ var ov=document.getElementById('schoolOverlay'); if(ov){ ov.classList.remove('active'); } if(typeof clearBusHighlight==='function'){ try{ clearBusHighlight(); }catch(e){} } }
    function wirePopupInteractions(root,p,isOverlay){ if(!root) return; var frame=root.querySelector('.popup-frame'); var imgEl=root.querySelector('.frame-img'); if(frame && imgEl){ imgEl.onerror=function(){ try{ imgEl.remove(); }catch(e){} }; if(window.getFrameURL){ window.getFrameURL().then(function(url){ if(url) imgEl.src=url; }); } } var dlBtn=root.querySelector('.popup-dl-btn'); if(dlBtn){ dlBtn.onclick = async function(ev){ ev.stopPropagation(); var targetFrame=root.querySelector('.popup-frame'); if(!targetFrame || typeof html2canvas==='undefined') return; var fc=targetFrame.querySelector('.frame-content'); if(!fc) return; var isMobile=((window.innerWidth||1024)<=600)||(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)); var scaleVal=isMobile?1.25:2; var visibleCanvas=await html2canvas(targetFrame,{ backgroundColor:null, useCORS:true, scale:scaleVal }); var hiddenCanvas=visibleCanvas; var piz = new Image(); piz.onload = function(){ var width=piz.width, height=piz.height; var totalWidth=hiddenCanvas && hiddenCanvas!==visibleCanvas ? width*2 : width; var finalCanvas=document.createElement('canvas'); finalCanvas.width=totalWidth; finalCanvas.height=height; var ctx=finalCanvas.getContext('2d'); ctx.drawImage(piz,0,0,width,height); ctx.drawImage(visibleCanvas,0,0,width,height); if(hiddenCanvas && hiddenCanvas!==visibleCanvas){ ctx.drawImage(piz,width,0,width,height); ctx.drawImage(hiddenCanvas,width,0,width,height); } var fname=String(p.nombre||'escuela').replace(/[^a-z0-9 -]/gi,'_'); if(!fname) fname='escuela'; fname += (hiddenCanvas && hiddenCanvas!==visibleCanvas)?'_doble.jpg':'.jpg'; var ua=(navigator.userAgent||''); var isIOS=/iPhone|iPad|iPod/i.test(ua); var isAndroid=/Android/i.test(ua); var isMobileDevice=isIOS||isAndroid; finalCanvas.toBlob(function(blob){ if(!blob) return; var url=URL.createObjectURL(blob); if(isMobileDevice){ try{ window.open(url,'_blank'); }catch(e){} setTimeout(function(){ try{ URL.revokeObjectURL(url); }catch(e){} }, 5000); alert('La imagen se abri√≥ en una nueva pesta√±a: '+fname+' (usa Guardar imagen del navegador.)'); } else { var a=document.createElement('a'); a.href=url; a.download=fname; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); alert('Imagen descargada: '+fname); } }, 'image/jpeg', 0.92); }; piz.onerror=function(){ var ancho=visibleCanvas.width, alto=visibleCanvas.height; var finalCanvas=document.createElement('canvas'); finalCanvas.width=ancho; finalCanvas.height=alto; var ctx=finalCanvas.getContext('2d'); ctx.drawImage(visibleCanvas,0,0,ancho,alto); var fname=String(p.nombre||'escuela').replace(/[^a-z0-9 -]/gi,'_')+'.jpg'; var ua=(navigator.userAgent||''); var isIOS=/iPhone|iPad|iPod/i.test(ua); var isAndroid=/Android/i.test(ua); var isMobileDevice=isIOS||isAndroid; finalCanvas.toBlob(function(blob){ if(!blob) return; var url=URL.createObjectURL(blob); if(isMobileDevice){ try{ window.open(url,'_blank'); }catch(e){} setTimeout(function(){ try{ URL.revokeObjectURL(url); }catch(e){} }, 5000); alert('La imagen se abri√≥ en una nueva pesta√±a: '+fname+' (usa Guardar imagen del navegador.)'); } else { var a=document.createElement('a'); a.href=url; a.download=fname; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); alert('Imagen descargada: '+fname); } }, 'image/jpeg', 0.92); }; piz.src = (targetFrame.querySelector('.frame-img') && targetFrame.querySelector('.frame-img').src) || 'pizarron.png'; }; } var volverBtn=root.querySelector('.popup-volver-btn'); if(volverBtn){ volverBtn.onclick=function(ev){ ev.stopPropagation(); if(isOverlay){ hideSchoolOverlay(); } else { map.closePopup(); } }; } }
    function showSchoolOverlay(html,p){ var ov=document.getElementById('schoolOverlay'); var inner=document.getElementById('schoolOverlayInner'); if(!ov||!inner) return; inner.innerHTML=html; ov.style.paddingTop='0'; ov.classList.add('active'); if(window.wirePopupInteractions){ window.wirePopupInteractions(inner,p,true); } }
    function startApp(){ var s=document.getElementById('splash'); var t=document.querySelector('.splash-texts-container'); var m=document.getElementById('mainApp'); var f=document.getElementById('flagContainer'); var e=document.getElementById('easterEgg'); if(s) s.style.display='none'; if(t) t.style.display='none'; if(f) f.style.display='none'; if(e) e.style.display='none'; if(m) m.style.display='block'; window.inSplashScreen=false; setTimeout(function(){ try{ map.invalidateSize(); }catch(e){} }, 350); }
    (function(){ var clickCount=0; var hideTimer=null; var circle=document.querySelector('.circle-bounce'); var btn=document.getElementById('startBtn'); function isOutside(t){ return !(circle&&circle.contains(t)) && !(btn&&btn.contains(t)); } function isInSplash(){ return window.inSplashScreen!==false; } function showEgg(){ var egg=document.getElementById('easterEgg'); if(!egg) return; egg.style.display='flex'; if(hideTimer) clearTimeout(hideTimer); hideTimer=setTimeout(function(){ egg.style.display='none'; }, 4000); } function showFlag(){ var flag=document.getElementById('flagContainer'); var circle=document.querySelector('.circle-bounce'); if(!flag || !circle) return; circle.style.display='none'; flag.style.display='block'; 
      // Detectar si es m√≥vil
      var isMobile = window.innerWidth <= 600;
       if(isMobile) {
         // Posici√≥n optimizada para m√≥vil - m√°s arriba
         flag.style.bottom='35%';
         flag.style.left='50%';
         flag.style.transform='translate(-50%, 0)';
         flag.style.top='auto';
       } else {
         // Posici√≥n original para desktop - m√°s arriba
         flag.style.bottom='45%';
         flag.style.left='50%';
         flag.style.transform='translate(-50%, 0)';
         flag.style.top='auto';
       }
      if(hideTimer) clearTimeout(hideTimer); } function hideFlag(){ var flag=document.getElementById('flagContainer'); var circle=document.querySelector('.circle-bounce'); if(!flag || !circle) return; flag.style.display='none'; circle.style.display='flex'; if(hideTimer) clearTimeout(hideTimer); } document.addEventListener('click', function(e){ if(!isInSplash()) return; if(isOutside(e.target)){ clickCount++; if(clickCount>=7){ clickCount=0; showEgg(); } } else { clickCount=0; } }, true); var circleElement=document.querySelector('.circle-bounce'); if(circleElement){ circleElement.addEventListener('dblclick', function(e){ if(!isInSplash()) return; e.stopPropagation(); showFlag(); }); } var flagElement=document.getElementById('flagContainer'); if(flagElement){ flagElement.addEventListener('click', function(e){ e.stopPropagation(); hideFlag(); }); } })();
    document.getElementById('startBtn').addEventListener('click', startApp);
    (function(){
      var btnSplash=document.getElementById('splashShareBtn');
      if(!btnSplash) return;
      var qrOverlay=document.getElementById('qrShareOverlay');
      var qrImg=document.getElementById('qrShareImg');
      var qrNative=document.getElementById('qrShareNativeBtn');
      var qrClose=document.getElementById('qrShareCloseBtn');
      var shareUrl='https://ema4k789-coder.github.io/MapaLaRaiz_PWA/';

      function showQr(){
        if(!qrOverlay || !qrImg) return;
        qrOverlay.style.display='flex';
        qrImg.src='https://api.qrserver.com/v1/create-qr-code/?size=220x220&data='+encodeURIComponent(shareUrl);
      }
      if(qrClose && qrOverlay){
        qrClose.addEventListener('click', function(){
          qrOverlay.style.display='none';
        });
        qrOverlay.addEventListener('click', function(ev){
          if(ev.target === qrOverlay){
            qrOverlay.style.display='none';
          }
        });
      }

      if(qrNative){
        qrNative.addEventListener('click', function(){
          if(navigator && navigator.share){
            try{
              navigator.share({
                title:'Mapa de Escuelas La Ra√≠z',
                text:'Mapa interactivo de escuelas de La Plata, Berisso y Ensenada',
                url:shareUrl
              }).catch(function(){});
              return;
            }catch(e){}
          }
          try{
            var dummy=document.createElement('input');
            dummy.value=shareUrl;
            document.body.appendChild(dummy);
            dummy.select();
            document.execCommand('copy');
            document.body.removeChild(dummy);
            alert('Enlace copiado al portapapeles:\\n'+shareUrl);
          }catch(e){
            alert('Pod√©s compartir este enlace:\\n'+shareUrl);
          }
        });
      }

      function doShare(){
        showQr();
      }
      btnSplash.addEventListener('click', doShare);
    })();

    map = L.map('map').setView([-34.921, -57.954], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19, attribution:'¬© OpenStreetMap contributors' }).addTo(map);
    map.createPane('boundariesGlowPane'); map.getPane('boundariesGlowPane').style.zIndex = 340;
    map.createPane('boundariesPane'); map.getPane('boundariesPane').style.zIndex = 341;
    map.createPane('localitiesGlowPane'); map.getPane('localitiesGlowPane').style.zIndex = 330;
    map.createPane('localitiesPane'); map.getPane('localitiesPane').style.zIndex = 331;
    map.createPane('railwaysPane'); map.getPane('railwaysPane').style.zIndex = 332;
    map.createPane('busRoutesPane'); map.getPane('busRoutesPane').style.zIndex = 333;
    function normalizeLocalidadName(s){ if(!s) return ''; var t=s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim().toLowerCase().replace(/\s+/g,' '); var m={ 'jos√© melchor romero':'melchor romero','jose melchor romero':'melchor romero','melchor romero':'melchor romero','villa montoro':'villa elvira','la cumbre':'san carlos','manuel b. gonnet':'gonnet','manuel b gonnet':'gonnet','gonnet':'gonnet' }; var canon=m[t]||t; return canon.replace(/(^|\s)\S/g,function(x){ return x.toUpperCase(); }); }
    function getColorByLevel(n){ if(!n) return '#757575'; var s=n.toLowerCase(); if(s.includes('inicial')) return '#0074D9'; if(s.includes('primaria')) return '#2ECC40'; if(s.includes('secundaria')) return '#FF4136'; if(s.includes('superior')) return '#FFDC00'; if(s.includes('art√≠stica')) return '#B10DC9'; if(s.includes('t√©cnicas y agrarias')) return '#3D9970'; if(s.includes('t√©cnica')) return '#FF851B'; if(s.includes('ciclo medio')) return '#7FDBFF'; if(s.includes('ciclo de iniciaci√≥n')) return '#39CCCC'; if(s.includes('cursos y talleres')) return '#F012BE'; if(s.includes('adultos')) return '#8E44AD'; if(s.includes('jard√≠n maternal')||s.includes('jardin maternal')) return '#3399FF'; var h=0; for(var i=0;i<s.length;i++) h=s.charCodeAt(i)+((h<<5)-h); return 'hsl('+(h%360)+', 70%, 55%)'; }
    function getBusRouteColorKey(props){ if(!props) return ''; return String(props.ref||props.name||props.operator||props.network||''); }
    function getBusRouteLabel(props){
      if(!props) return '';
      var ref=String(props.ref||'').trim();
      var name=String(props.name||'').trim();
      var op=String(props.operator||'').trim();
      if(ref){
        var upper=ref.toUpperCase();
        var m=upper.match(/^(\d+)\s*([A-Z√Å√â√ç√ì√ö√ë0-9]+)?$/);
        if(m){
          var num=m[1];
          var suf=m[2]||'';
          return suf ? (num+' '+suf) : num;
        }
        return upper;
      }
      if(name){
        var idx=name.indexOf(':');
        if(idx!==-1) name=name.slice(0,idx);
        name=name.replace(/\bRamal\b/gi,'').replace(/\s{2,}/g,' ').trim();
        return name;
      }
      if(op) return op;
      return '';
    }
    function getBusRouteColorFromKey(key){ if(!key) return '#cc00cc'; var s=String(key).toLowerCase(); var h=0; for(var i=0;i<s.length;i++) h=s.charCodeAt(i)+((h<<5)-h); return 'hsl('+(h%360)+', 80%, 45%)'; }
    function styleBusRoute(feature){ var p=feature&&feature.properties; var key=getBusRouteColorKey(p); var color=getBusRouteColorFromKey(key); return { color:color, weight:2.5, opacity:0.9, pane:'busRoutesPane' }; }
    function busRegionBBox(){ return { minLat:-35.20, maxLat:-34.60, minLon:-58.30, maxLon:-57.30 }; }
    function busInBBox(pt,b){ var lat=pt[0], lon=pt[1]; return lat>=b.minLat && lat<=b.maxLat && lon>=b.minLon && lon<=b.maxLon; }
    function busClipPolyline(latlngs,b){ var segs=[]; var cur=[]; for(var i=0;i<latlngs.length;i++){ var pt=latlngs[i]; if(busInBBox(pt,b)){ cur.push(pt); } else { if(cur.length>1){ segs.push(cur); } cur=[]; } } if(cur.length>1) segs.push(cur); return segs; }
    function loadBusRoutesIfNeeded(){
      if(busRoutesDataLoaded||busRoutesLayer) return Promise.resolve();
      return fetch('recorridos_lp.geojson',{ cache:'no-store' })
        .then(function(r){ if(!r||!r.ok) throw new Error('no-data'); return r.json(); })
        .then(function(gj){
        var rawFeatures=[];
        if(Array.isArray(gj.features)){ rawFeatures=rawFeatures.concat(gj.features); }
        else if(gj.type==='FeatureCollection' && Array.isArray(gj.features)){ rawFeatures=rawFeatures.concat(gj.features); }
        else { rawFeatures.push({ type:'Feature', properties:gj.properties||{}, geometry:gj.geometry||null }); }
        var b=busRegionBBox();
        var baseSegments=[];
        var keySamples={};
        rawFeatures.forEach(function(f){
          if(!f||!f.geometry) return;
          var g=f.geometry;
          var props=f.properties||{};
          var key=getBusRouteColorKey(props);
          if(!key) key='(sin identificador)';
          props._busKey=key;
          if(g.type==='LineString' && Array.isArray(g.coordinates)){
            var latlngs=g.coordinates.map(function(c){ return [c[1],c[0]]; });
            var segs=busClipPolyline(latlngs,b);
            if(segs.length===0) return;
            segs.forEach(function(seg){
              var coords=seg.map(function(p){ return [p[1],p[0]]; });
              baseSegments.push({ type:'Feature', properties:props, geometry:{ type:'LineString', coordinates:coords } });
            });
          } else if(g.type==='MultiLineString' && Array.isArray(g.coordinates)){
            g.coordinates.forEach(function(line){
              if(!Array.isArray(line)) return;
              var latlngs=line.map(function(c){ return [c[1],c[0]]; });
              var segs=busClipPolyline(latlngs,b);
              if(segs.length===0) return;
              segs.forEach(function(seg){
                var coords=seg.map(function(p){ return [p[1],p[0]]; });
                baseSegments.push({ type:'Feature', properties:props, geometry:{ type:'LineString', coordinates:coords } });
              });
            });
          }
        });
        if(baseSegments.length===0) throw new Error('no-data');
        busRoutesAllFeatures=baseSegments;
        baseSegments.forEach(function(f){ var p=f.properties||{}; var k=String(p._busKey||''); if(!k) return; if(!keySamples[k]) keySamples[k]=p; });
        busRouteKeys=Object.keys(keySamples);
        busRouteKeySamples=keySamples;
        busRoutesDataLoaded=true;
        populateBusRouteSelect();
        rebuildBusRoutesLayer();
      }).catch(function(err){ return Promise.reject(err); });
    }
    function populateBusRouteSelect(){
      var sel=busRouteSelect;
      if(!sel) return;
      sel.innerHTML='';
      var keys=Array.isArray(busRouteKeys)?busRouteKeys.slice():[];
      if(keys.length===0){ sel.style.display='none'; return; }
      keys.sort(function(a,b){ return String(a).localeCompare(String(b),'es'); });
      var optAll=document.createElement('option'); optAll.value=''; optAll.textContent='Todas las l√≠neas'; sel.appendChild(optAll);
      keys.forEach(function(k){
        var props=busRouteKeySamples&&busRouteKeySamples[k];
        var label=getBusRouteLabel(props);
        var o=document.createElement('option'); o.value=k; o.textContent=label; sel.appendChild(o);
      });
      sel.value='';
      sel.style.display='';
    }
    function getCurrentBusBBox(){
      var d=(distritoSelect&&distritoSelect.value)||'';
      var loc=(localidadSelect&&localidadSelect.value)||'';
      if(!d) return busRegionBBox();
      var bbox=null;
      var locKey=(loc||'').trim().toLowerCase();
      var useCasco=locKey==='casco urbano';
      allSchools.forEach(function(f){
        var p=f.properties||{};
        if((p.distrito||'')!==d) return;
        var ln=(p.localidad_norm||'').trim().toLowerCase();
        if(locKey){
          if(useCasco){
            if(ln!=='la plata') return;
          } else {
            if(ln!==locKey) return;
          }
        }
        var g=f.geometry;
        if(!g||!Array.isArray(g.coordinates)) return;
        var lon=Number(g.coordinates[0]);
        var lat=Number(g.coordinates[1]);
        if(isNaN(lat)||isNaN(lon)) return;
        if(!bbox){
          bbox={ minLat:lat, maxLat:lat, minLon:lon, maxLon:lon };
        } else {
          if(lat<bbox.minLat) bbox.minLat=lat;
          if(lat>bbox.maxLat) bbox.maxLat=lat;
          if(lon<bbox.minLon) bbox.minLon=lon;
          if(lon>bbox.maxLon) bbox.maxLon=lon;
        }
      });
      if(!bbox) return busRegionBBox();
      var m=0.02;
      return { minLat:bbox.minLat-m, maxLat:bbox.maxLat+m, minLon:bbox.minLon-m, maxLon:bbox.maxLon+m };
    }
    function busDistanceMeters(lat1,lng1,lat2,lng2){
      var R=6371000;
      var toRad=function(x){ return x*Math.PI/180; };
      var dLat=toRad(lat2-lat1);
      var dLng=toRad(lng2-lng1);
      var a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)*Math.sin(dLng/2);
      var c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
      return R*c;
    }
    function busPointToSegmentDistance(lat,lng,lat1,lng1,lat2,lng2){
      var toRad=function(x){ return x*Math.PI/180; };
      var R=6371000;
      var phi1=toRad(lat1), phi2=toRad(lat2), phiP=toRad(lat);
      var lambda1=toRad(lng1), lambda2=toRad(lng2), lambdaP=toRad(lng);
      var Ax=R*Math.cos(phi1)*Math.cos(lambda1);
      var Ay=R*Math.cos(phi1)*Math.sin(lambda1);
      var Az=R*Math.sin(phi1);
      var Bx=R*Math.cos(phi2)*Math.cos(lambda2);
      var By=R*Math.cos(phi2)*Math.sin(lambda2);
      var Bz=R*Math.sin(phi2);
      var Px=R*Math.cos(phiP)*Math.cos(lambdaP);
      var Py=R*Math.cos(phiP)*Math.sin(lambdaP);
      var Pz=R*Math.sin(phiP);
      var ABx=Bx-Ax, ABy=By-Ay, ABz=Bz-Az;
      var APx=Px-Ax, APy=Py-Ay, APz=Pz-Az;
      var ab2=ABx*ABx+ABy*ABy+ABz*ABz;
      if(!ab2){ var dx=Px-Ax, dy=Py-Ay, dz=Pz-Az; return Math.sqrt(dx*dx+dy*dy+dz*dz); }
      var t=(APx*ABx+APy*ABy+APz*ABz)/ab2;
      if(t<0)t=0; else if(t>1)t=1;
      var Cx=Ax+ABx*t, Cy=Ay+ABy*t, Cz=Az+ABz*t;
      var dx=Px-Cx, dy=Py-Cy, dz=Pz-Cz;
      return Math.sqrt(dx*dx+dy*dy+dz*dz);
    }
    function rebuildBusRoutesLayer(){
      if(!busRoutesDataLoaded||!busRoutesAllFeatures||busRoutesAllFeatures.length===0) return;
      var b=getCurrentBusBBox();
      var selKey = busRouteSelect ? String(busRouteSelect.value||'') : '';
      var features=[];
      busRoutesAllFeatures.forEach(function(f){
        if(!f||!f.geometry) return;
        var g=f.geometry;
        var p=f.properties||{};
        if(selKey){
          var k=getBusRouteColorKey(p);
          if(String(k)!==selKey) return;
        }
        if(g.type!=='LineString'||!Array.isArray(g.coordinates)) return;
        var latlngs=g.coordinates.map(function(c){ return [c[1],c[0]]; });
        var segs=busClipPolyline(latlngs,b);
        if(segs.length===0) return;
        segs.forEach(function(seg){
          var coords=seg.map(function(p){ return [p[1],p[0]]; });
          features.push({ type:'Feature', properties:f.properties||{}, geometry:{ type:'LineString', coordinates:coords } });
        });
      });
      if(busRoutesLayer){ if(map.hasLayer(busRoutesLayer)) map.removeLayer(busRoutesLayer); busRoutesLayer=null; }
      if(features.length===0) return;
      var merged={ type:'FeatureCollection', features:features };
      busRoutesLayer=L.geoJSON(merged,{ style:styleBusRoute, onEachFeature:function(feat,layer){ var p=feat&&feat.properties; var label=getBusRouteLabel(p); try{ layer.bindTooltip(label,{ permanent:false, direction:'auto', sticky:true }); }catch(e){} } });
      if(busRoutesVisible){ busRoutesLayer.addTo(map); }
    }
    function highlightBusRoutesForSchool(lat,lng){
      if(!busRoutesDataLoaded){
        loadBusRoutesIfNeeded().then(function(){ highlightBusRoutesForSchool(lat,lng); });
        return;
      }
      var MAX_CERCA=300;
      var MAX_LEJOS=1000;
      var near=[];
      busRoutesAllFeatures.forEach(function(f){
        if(!f||!f.geometry||f.geometry.type!=='LineString') return;
        var coords=f.geometry.coordinates||[];
        if(!coords||coords.length<2) return;
        var minDist=Infinity;
        for(var i=0;i<coords.length-1;i++){
          var c1=coords[i], c2=coords[i+1];
          var d=busPointToSegmentDistance(lat,lng,c1[1],c1[0],c2[1],c2[0]);
          if(d<minDist) minDist=d;
          if(minDist<=MAX_LEJOS) break;
        }
        if(minDist<=MAX_LEJOS){
          near.push({ feature:f, dist:minDist });
        }
      });
      if(busRoutesHighlightLayer){ try{ map.removeLayer(busRoutesHighlightLayer); }catch(e){} busRoutesHighlightLayer=null; }
      if(!near.length) return;
      var useThreshold=MAX_CERCA;
      var hasClose=near.some(function(x){ return x.dist<=MAX_CERCA; });
      if(!hasClose) useThreshold=MAX_LEJOS;
      var features=[];
      near.forEach(function(x){
        if(x.dist<=useThreshold){
          features.push(x.feature);
        }
      });
      if(!features.length) return;
      var merged={ type:'FeatureCollection', features:features };
      busRoutesHighlightLayer=L.geoJSON(merged,{ style:function(feat){ var p=feat&&feat.properties; var key=getBusRouteColorKey(p); var color=getBusRouteColorFromKey(key); return { color:color, weight:5, opacity:1, pane:'busRoutesPane' }; }, onEachFeature:function(feat,layer){ var p=feat&&feat.properties; var label=getBusRouteLabel(p); try{ layer.bindTooltip(label,{ permanent:true, direction:'top', offset:[0,-6], sticky:false, className:'bus-route-label' }); }catch(e){} } });
      try{ busRoutesHighlightLayer.addTo(map); }catch(e){}
    }
    function updateBusRoutesVisibility(){ if(!busRoutesLayer) return; if(busRoutesVisible){ if(!map.hasLayer(busRoutesLayer)) busRoutesLayer.addTo(map); } else { if(map.hasLayer(busRoutesLayer)) map.removeLayer(busRoutesLayer); } }
    function clearBusHighlight(){ if(busRoutesHighlightLayer){ try{ map.removeLayer(busRoutesHighlightLayer); }catch(e){} busRoutesHighlightLayer=null; } }
    function getLineAndRamalForProps(props){
      if(!props) return null;
      var label=getBusRouteLabel(props);
      if(!label) return null;
      var parts=label.split(/\s+/);
      var line=parts.shift()||'';
      var ramal=parts.join(' ').trim();
      if(!line) return null;
      var lineUpper=line.toUpperCase();
      if(ramal){
        var rTrim=ramal.trim();
        var ru=rTrim.toUpperCase();
        if(ru.indexOf(lineUpper+' ')===0){
          rTrim=rTrim.slice(line.length).trim();
        }
        if(/^ramal\s+/i.test(rTrim)){
          rTrim=rTrim.replace(/^ramal\s+/i,'').trim();
        }
        var tokens=rTrim.split(/\s+/).filter(function(t){ return t && t.toUpperCase()!==lineUpper; });
        rTrim=tokens.join(' ');
        ramal=rTrim;
      }
      return { line:line, ramal:ramal };
    }
    function computeBusSummaryForSchool(lat,lng){
      if(!busRoutesDataLoaded||!Array.isArray(busRoutesAllFeatures)||busRoutesAllFeatures.length===0) return '';
      if(isNaN(lat)||isNaN(lng)) return '';
      var MAX_LEJOS=1000;
      var near=[];
      busRoutesAllFeatures.forEach(function(f){
        try{
          var g=f&&f.geometry;
          if(!g||g.type!=='LineString'||!Array.isArray(g.coordinates)) return;
          var coords=g.coordinates;
          if(!coords||coords.length<2) return;
          var best=Infinity;
          for(var i=0;i<coords.length-1;i++){
            var c1=coords[i], c2=coords[i+1];
            var d=busPointToSegmentDistance(lat,lng,c1[1],c1[0],c2[1],c2[0]);
            if(d<best) best=d;
            if(best<=MAX_LEJOS) break;
          }
          if(best<=MAX_LEJOS){
            near.push({ feature:f, dist:best });
          }
        }catch(e){}
      });
      if(!near.length) return '';
      near.sort(function(a,b){ return a.dist-b.dist; });
      var groups={};
      var maxLines=15;
      for(var i=0;i<near.length;i++){
        var x=near[i];
        var lr=getLineAndRamalForProps((x.feature&&x.feature.properties)||{});
        if(!lr||!lr.line) continue;
        if(!groups[lr.line]) groups[lr.line]={ line:lr.line, ramales:new Set(), bestDist:x.dist };
        var g=groups[lr.line];
        if(x.dist<g.bestDist) g.bestDist=x.dist;
        if(lr.ramal){ g.ramales.add(lr.ramal); }
      }
      var keys=Object.keys(groups);
      if(!keys.length) return '';
      keys.sort(function(a,b){
        var da=groups[a].bestDist;
        var db=groups[b].bestDist;
        if(da!==db) return da-db;
        var na=parseFloat(a.replace(/[^0-9.]/g,'')); var nb=parseFloat(b.replace(/[^0-9.]/g,''));
        if(!isNaN(na)&&!isNaN(nb)&&na!==nb) return na-nb;
        return a.localeCompare(b,'es');
      });
      if(keys.length>maxLines){ keys=keys.slice(0,maxLines); }
      var parts=[];
      keys.forEach(function(k){
        var g=groups[k];
        if(!g) return;
        var txt=String(g.line||'').trim();
        var rams=Array.from(g.ramales||[]);
        rams=rams.filter(function(r){ return r&&r.trim(); });
        if(rams.length){
          if(txt){ txt+=': '; }
          txt+=rams.join(', ');
        }
        parts.push(txt);
      });
      return parts.join(' | ');
    }
    function normalizeComoLlegoText(str){
      var s=String(str||'');
      if(!s) return s;
      s=s.replace(/L[√≠i]nea\s+/gi,'');
      var firstCuad=null;
      s=s.replace(/\b(a\s+[\w\d]+\s+cuadras?\b[^.;,)]*)/gi,function(m){
        if(firstCuad===null){
          firstCuad=m;
          return m;
        }
        return '';
      });
      return s.replace(/\s{2,}/g,' ').trim();
    }
    function updateComoLlegoForRoot(root,lat,lng){
      try{
        if(!root) return;
        var span=root.querySelector('.field-line-comollego .comollego-text');
        if(!span) return;
        loadBusRoutesIfNeeded().then(function(){
          var txt=computeBusSummaryForSchool(lat,lng);
          if(txt){ span.textContent=txt; } else { span.textContent=normalizeComoLlegoText(span.textContent||''); }
        }).catch(function(){
          span.textContent=normalizeComoLlegoText(span.textContent||'');
        });
      }catch(e){}
    }
    function clearMarkers(){ markers.forEach(function(m){ map.removeLayer(m); }); markers=[]; }
    function renderMarkers(arr){ var a=Array.isArray(arr)?arr:[]; clearMarkers(); a.forEach(function(f){ try{ var p=f.properties||{}; var lat=NaN,lng=NaN; if(f.geometry&&Array.isArray(f.geometry.coordinates)){ lng=Number(f.geometry.coordinates[0]); lat=Number(f.geometry.coordinates[1]); } if(isNaN(lat)||isNaN(lng)){ lat=Number(p.latitud||p.lat||p.latitude); lng=Number(p.longitud||p.lng||p.longitude); } if(isNaN(lat)||isNaN(lng)) return; var nivel=(p.nivel||''); var nombreStr=String(p.nombre||''); var tipoStr=String(p.tipo_organizacion||''); var color=getColorByLevel(nivel); if(nombreStr.includes('adultos')||nombreStr.includes('Adultos')||nombreStr.includes('ADULTOS')){ color='#8E44AD'; } if( nombreStr.includes('JARD√çN MATERNAL')||nombreStr.includes('JARDIN MATERNAL')||nombreStr.includes('Jard√≠n Maternal')||nombreStr.includes('Jardin Maternal')|| tipoStr.includes('JARD√çN MATERNAL')||tipoStr.includes('JARDIN MATERNAL') ){ color='#3399FF'; } var m=L.circleMarker([lat,lng],{ color:color, fillColor:color, radius:12, weight:3, fillOpacity:0.85, opacity:1 }).addTo(map);
        var toUp=function(x){ return String(x||'').toLocaleUpperCase('es-ES'); };
        var datosHtml="<div class='popup-frame'><img class='frame-img' src='pizarron.png' alt=''><button class='popup-dl-btn' title='Descargar ficha'>üíæ</button><div class='frame-content'>";
        datosHtml += "<div class='general-fields'>";
        datosHtml += "<div class='name-tag'>"+escapeHtml(String(p.nombre||''))+"</div>";
        datosHtml += "<div class='field-line'><b>N√öMERO DE ESCUELA:</b> "+escapeHtml(String(p.nro_escuela||''))+"</div>";
        var dirVal = String(p.calle||''); var puerta = String(p.numero||'').trim(); if(puerta){ dirVal = dirVal ? (dirVal + ' ' + puerta) : puerta; }
        datosHtml += "<div class='field-line'><b>DIRECCI√ìN:</b> "+escapeHtml(dirVal)+"</div>";
        var desfRaw=String(p.desfavorabilidad||'').trim(); if(!desfRaw){ desfRaw='No'; }
        datosHtml += "<div class='field-line'><b>DESFAVORABILIDAD:</b> "+escapeHtml(desfRaw)+"</div>";
        datosHtml += "<div class='field-line'><b>DISTRITO:</b> "+escapeHtml(String(p.distrito||''))+"</div>";
        datosHtml += "<div class='field-line'><b>LOCALIDAD:</b> "+escapeHtml(String(p.localidad||''))+"</div>";
        datosHtml += "<div class='field-line'><b>NIVEL:</b> "+escapeHtml(String(p.nivel||''))+"</div>";
        datosHtml += "<div class='field-line'><b>CLAVE:</b> "+escapeHtml(String(p.clave||''))+"</div>";
        datosHtml += "</div>";
        var comoRaw=String(p['COMO LLEGO']||''); var comoNorm=normalizeComoLlegoText(comoRaw);
        datosHtml += "<div class='como-fields'><div class='field-line field-line-comollego'><b>C√ìMO LLEGO:</b> <span class='comollego-text'>"+escapeHtml(comoNorm)+"</span></div></div>";
        datosHtml += "</div><button type='button' class='popup-volver-btn'>VOLVER</button></div>";
        if(isMobilePortrait()){
          m.on('click', function(){ onPopupOpenCommon(); showSchoolOverlay(datosHtml,p); highlightBusRoutesForSchool(lat,lng); updateComoLlegoForRoot(document.getElementById('schoolOverlayInner'),lat,lng); });
        } else {
          m.bindPopup(datosHtml,{ closeButton:false, autoClose:true, closeOnClick:true, autoPan:false });
          m.on('popupopen', function(){ onPopupOpenCommon(); var content=document.querySelector('.leaflet-popup-content'); if(!content) return; if(window.wirePopupInteractions){ window.wirePopupInteractions(content,p,false); } highlightBusRoutesForSchool(lat,lng); updateComoLlegoForRoot(content,lat,lng); });
          m.on('popupclose', function(){ if(typeof clearBusHighlight==='function'){ try{ clearBusHighlight(); }catch(e){} } });
        }
        markers.push(m); }catch(e){} }); var c=document.getElementById('counter'); if(c) c.textContent=String(a.length); }
    var distritoSelect=document.getElementById('filterDistrito'); var localidadSelect=document.getElementById('filterLocalidad'); var searchInput=document.getElementById('searchInput'); var clearSearchBtn=document.getElementById('clearSearchBtn'); var levelAll=null; var levelChecks=[]; var toggleBusRoutesBtn=document.getElementById('toggleBusRoutesBtn'); var busRouteSelect=document.getElementById('busRouteSelect');
    function escapeHtml(str){ return String(str||'').replace(/[&<>"']/g,function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'})[m]; }); }
    function setClearSearchVisible(){ if(!clearSearchBtn||!searchInput) return; var wrap=clearSearchBtn.parentNode; if(!wrap || !wrap.classList) return; wrap.classList.toggle('has-text', String(searchInput.value||'').length>0); }
    function updateLevelsBadgeCount(){ var btn=document.getElementById('levelsHeaderBtn'); if(!btn) return; var total=Array.isArray(levelChecks)?levelChecks.length:0; var count=(levelAll && levelAll.checked) ? total : levelChecks.filter(function(cb){ return cb.checked; }).length; btn.setAttribute('data-count', String(count)); }
    function populateLocalities(){ var distrito=(distritoSelect.value||'').trim(); if(!distrito || distrito!=='La Plata'){ if(localidadSelect){ localidadSelect.value=''; localidadSelect.innerHTML=''; localidadSelect.style.display='none'; } return; } var base=getBaseFeatures(); var locSet=new Set(); var hasLaPlata=false; base.forEach(function(f){ var p=f.properties||{}; if((p.distrito||'').trim()===distrito){ var canon=(p.localidad_norm||normalizeLocalidadName(p.localidad||'')); if(canon){ if(canon==='La Plata') hasLaPlata=true; locSet.add(canon); } } }); var list=Array.from(locSet).sort(function(a,b){ return a.localeCompare(b,'es'); }); localidadSelect.innerHTML=''; var opt=document.createElement('option'); opt.value=''; opt.textContent='Todas las localidades'; localidadSelect.appendChild(opt); if(distrito==='La Plata'&&hasLaPlata){ var cascoOpt=document.createElement('option'); cascoOpt.value='Casco Urbano'; cascoOpt.textContent='Casco Urbano'; localidadSelect.appendChild(cascoOpt); }
      list.forEach(function(l){ var ln=l.trim().toLowerCase(); if(distrito==='La Plata' && ln==='la plata') return; var o=document.createElement('option'); if(ln==='san carlos'){ o.value='SAN CARLOS'; o.textContent='SAN CARLOS'; } else { o.value=l; o.textContent=l; } localidadSelect.appendChild(o); }); localidadSelect.style.display=''; }
    function getBaseFeatures(){ return allSchools.map(function(f){ var p=f.properties||{}; p.localidad_norm=normalizeLocalidadName(p.localidad||''); f.properties=p; return f; }); }
    function clearPoiMarkers(){ try{ poiMarkers.forEach(function(m){ try{ map.removeLayer(m); }catch(e){} }); poiMarkers=[]; }catch(e){} }
    function renderPoiMarkers(){
      if(!poiVisible || !Array.isArray(poiFeatures)) return;
      clearPoiMarkers();
      var svg="<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><defs><linearGradient id='g1' x1='0' y1='0' x2='0' y2='1'><stop offset='0%' stop-color='#ffeb3b'/><stop offset='50%' stop-color='#ff9800'/><stop offset='100%' stop-color='#f44336'/></linearGradient></defs><circle cx='32' cy='32' r='30' fill='url(#g1)'/><rect x='20' y='20' width='24' height='30' fill='#ffffff' stroke='#1a237e' stroke-width='2'/><polygon points='32,10 16,20 48,20' fill='#1a237e'/><rect x='28' y='34' width='8' height='16' fill='#ffeb3b' stroke='#1a237e' stroke-width='2'/></svg>";
      var icon=L.icon({
        iconUrl:'data:image/svg+xml;utf8,'+encodeURIComponent(svg),
        iconSize:[64,64],
        iconAnchor:[32,64],
        popupAnchor:[0,-44],
        className:'poi-building-img'
      });
      poiFeatures.forEach(function(f){
        try{
          var coords=f.geometry&&f.geometry.coordinates;
          if(!coords||coords.length<2) return;
          var lat=Number(coords[1]), lng=Number(coords[0]);
          if(isNaN(lat)||isNaN(lng)) return;
          var p=f.properties||{};
          var nombreBase=p.Lugar||p.nombre||p.nombre_lugar||p.titulo||p.descripcion||'';
          var nombreFinal=nombreBase||'Lugar de inter√©s docente';
          var m=L.marker([lat,lng],{ icon:icon }).addTo(map);
          var html="<div class='popup-frame'><img class='frame-img' src='pizarron.png' alt=''><button class='popup-dl-btn' title='Descargar imagen'>‚¨á</button><div class='frame-content'>";
          html+="<div class='name-tag'>"+nombreFinal+"</div>";
          Object.keys(p).forEach(function(k){
            var kl=(k||'').toString().toLowerCase();
            if(kl.indexOf('lat')!==-1 || kl.indexOf('long')!==-1 || kl.indexOf('coord')!==-1) return;
            if(k && k[0]==='_') return;
            if(kl==='tipo_lugar' || kl==='origen_lugar' || kl==='localidad_norm') return;
            if(k==='Lugar') return;
            html+="<div class='field-line'><b>"+k+":</b> "+p[k]+"</div>";
          });
          html+="</div><button type='button' class='popup-volver-btn'>VOLVER</button></div>";
          if(isMobilePortrait()){
            m.on('click', function(){ onPopupOpenCommon(); showSchoolOverlay(html,p); });
          } else {
            m.bindPopup(html,{ closeButton:false, autoClose:true, closeOnClick:true, autoPan:false });
            m.on('popupopen', function(){ onPopupOpenCommon(); var content=document.querySelector('.leaflet-popup-content'); if(!content) return; if(window.wirePopupInteractions){ window.wirePopupInteractions(content,p,false); } });
          }
          poiMarkers.push(m);
        }catch(e){}
      });
    }
    function filterSchools(){ var text=(searchInput.value||'').trim().toLowerCase(); var distrito=distritoSelect.value||''; var localidad=(localidadSelect&&localidadSelect.value)||''; var base=getBaseFeatures();
      function normStr(s){ return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').trim().toLowerCase(); }
      var levelAllChecked = !!(document.getElementById('levelAll') && document.getElementById('levelAll').checked);
      var selectedLevels = Array.isArray(levelChecks) ? levelChecks.filter(function(cb){ return cb.checked; }).map(function(cb){ return cb.value; }) : [];
      var tecnicaSolo = (!levelAllChecked && selectedLevels.length===1 && selectedLevels[0]==='T√©cnica');
      var filtered = base.slice();
      if(!levelAllChecked){ if(selectedLevels.length===0){ filtered = []; } else if(tecnicaSolo){ filtered = filtered.filter(function(f){ return (f.properties && f.properties.nombre)==='escuela de educacion tecnica'; }); } else { var selectedNorms = selectedLevels.map(normStr); filtered = filtered.filter(function(f){ var p=f.properties||{}; var n=normStr(p.nivel||''); var torg=(p.tipo_organizacion||''); var tecnAgraSel=normStr('T√©cnicas y Agrarias'); var adultosSel=normStr('ADULTOS'); var jardinMatSel=normStr('JARDIN MATERNAL'); var nombreVal=(p.nombre||''); var agrariaName=nombreVal.includes('ESCUELA DE EDUCACI√ìN SECUNDARIA AGRARIA'); var adultosName=nombreVal.includes('adultos')||nombreVal.includes('Adultos')||nombreVal.includes('ADULTOS'); var jmName=nombreVal.includes('JARD√çN MATERNAL')||nombreVal.includes('JARDIN MATERNAL')||nombreVal.includes('Jard√≠n Maternal')||nombreVal.includes('Jardin Maternal'); var inicialSel=normStr('Nivel Inicial'); return selectedNorms.some(function(l){ if(adultosName){ return l===adultosSel; } if(agrariaName){ return l===tecnAgraSel; } if(l===jardinMatSel){ return jmName; } if(l==='artistica'){ return n.includes('artistica')||n.includes('ciclo medio'); } if(l===tecnAgraSel){ return torg==='ESCUELA DE EDUCACI√ìN SECUNDARIA T√âCNICA' || torg==='ESCUELA DE EDUCACI√ìN SECUNDARIA AGRARIA' || (p.nivel||'')==='AGRARIA' || n==='centro de educacion agraria'; } if(l===inicialSel){ return n.includes(l) && !jmName; } return n.includes(l); }); }); } }
      if(distrito){ filtered = filtered.filter(function(f){ return (f.properties&&f.properties.distrito||'')===distrito; }); }
      if(localidad){ var locSel = localidad.trim().toLowerCase(); if(locSel==='casco urbano'){ filtered = filtered.filter(function(f){ return ((f.properties&&f.properties.localidad_norm)||'').trim().toLowerCase()==='la plata'; }); } else { filtered = filtered.filter(function(f){ return ((f.properties&&f.properties.localidad_norm)||'').trim().toLowerCase()===locSel; }); } }
      if(text){ filtered = filtered.filter(function(f){ var p=f.properties||{}; return (p.nombre||'').toLowerCase().includes(text) || (p.numero||'').toString().toLowerCase().includes(text) || (p.nivel||'').toLowerCase().includes(text) || (p.localidad||'').toLowerCase().includes(text) || (p.localidad_norm||'').toLowerCase().includes(text); }); }
      clearMarkers(); renderMarkers(filtered); var c=document.getElementById('counter'); if(c) c.textContent=filtered.length; updateLevelsBadgeCount(); }
    if(toggleBusRoutesBtn){ toggleBusRoutesBtn.addEventListener('click', function(ev){ try{ ev.preventDefault(); ev.stopPropagation(); }catch(e){} busRoutesVisible=!busRoutesVisible; if(busRoutesVisible){ toggleBusRoutesBtn.classList.add('active'); if(busRoutesDataLoaded){ updateBusRoutesVisibility(); if(busRouteSelect){ busRouteSelect.style.display=''; } } else { loadBusRoutesIfNeeded().then(function(){ updateBusRoutesVisibility(); if(busRouteSelect){ busRouteSelect.style.display=''; } }).catch(function(){ busRoutesVisible=false; toggleBusRoutesBtn.classList.remove('active'); }); } } else { toggleBusRoutesBtn.classList.remove('active'); updateBusRoutesVisibility(); if(busRouteSelect){ busRouteSelect.value=''; busRouteSelect.style.display='none'; } } }); }
    var togglePoiBtn=document.getElementById('togglePoiBtn'); if(togglePoiBtn){ togglePoiBtn.addEventListener('click', function(ev){ try{ ev.preventDefault(); ev.stopPropagation(); }catch(e){} poiVisible=!poiVisible; if(poiVisible){ togglePoiBtn.classList.add('active'); renderPoiMarkers(); } else { togglePoiBtn.classList.remove('active'); clearPoiMarkers(); } }); }
    if(busRouteSelect){ busRouteSelect.addEventListener('change', function(){ if(busRoutesVisible&&busRoutesDataLoaded){ rebuildBusRoutesLayer(); } }); }
    if(clearSearchBtn){ clearSearchBtn.addEventListener('click', function(ev){ try{ ev.preventDefault(); ev.stopPropagation(); }catch(e){} if(!searchInput) return; searchInput.value=''; setClearSearchVisible(); filterSchools(); try{ searchInput.focus(); }catch(e){} }); }
    distritoSelect.addEventListener('change', function(){ populateLocalities(); filterSchools(); applyPanelPosition(); updateDisplayForSelectedDistrict(); if((distritoSelect.value||'').trim()==='La Plata'){ addLocalityBoundariesLaPlata(); } if(busRoutesVisible&&busRoutesDataLoaded){ rebuildBusRoutesLayer(); } }); if(localidadSelect){ localidadSelect.addEventListener('change', function(){ filterSchools(); updateDisplayForSelectedDistrict(); if(busRoutesVisible&&busRoutesDataLoaded){ rebuildBusRoutesLayer(); } }); } searchInput.addEventListener('input', function(){ setClearSearchVisible(); filterSchools(); }); setClearSearchVisible();
    function isPolygonGeojson(g){ return !!g && (g.type==='Polygon' || g.type==='MultiPolygon'); }
    function addBoundaryGeoJSON(geojson){ try{ var glow=L.geoJSON(geojson,{ pane:'boundariesGlowPane', color:'#ff0033', weight:28, opacity:0.22, fill:false }).addTo(map); var sharp=L.geoJSON(geojson,{ pane:'boundariesPane', color:'#ff0033', weight:3, opacity:0.9, fill:false }).addTo(map); boundaryLayers.push(glow); boundaryLayers.push(sharp); }catch(e){} }
    function tryLoadMunicipalBoundaries(){ return fetch('municipios_boundaries.geojson').then(function(r){ if(!r||!r.ok) return null; return r.json(); }).then(function(gj){ if(!gj) return false; var feats=Array.isArray(gj.features)?gj.features:[]; feats.forEach(function(f){ var g=f&&f.geometry; var n=f&&f.properties&&f.properties.name; if(g&&isPolygonGeojson(g)){ municipioGeomByName[(n||'').toLowerCase()]=g; } }); Object.keys(municipioGeomByName).forEach(function(k){ addBoundaryGeoJSON(municipioGeomByName[k]); }); return true; }).catch(function(){ return false; }); }
    var boundariesHidden=false; var railwayLayers=[]; var localityLayers=[]; var cachedLocalitiesLP=null;
    function clearBoundaryLayers(){ try{ boundaryLayers.forEach(function(l){ try{ map.removeLayer(l); }catch(e){} }); boundaryLayers=[]; }catch(e){} }
    function clearLocalityLayers(){ try{ localityLayers.forEach(function(l){ try{ map.removeLayer(l); }catch(e){} }); localityLayers=[]; }catch(e){} }
    function setBoundariesHidden(h){ boundariesHidden=!!h; var btn=document.getElementById('toggleBoundariesVisibilityBtn'); if(btn){ btn.title = boundariesHidden ? 'Mostrar l√≠mites' : 'Ocultar l√≠mites'; } updateDisplayForSelectedDistrict(); }
    function tryLoadLocalBoundaryLines(){ return fetch('localidades_limites_lineas.geojson', { cache:'no-store' }).then(function(r){ if(!r||!r.ok) return false; return r.json(); }).then(function(gj){ var feats=Array.isArray(gj.features)?gj.features:[]; feats.forEach(function(f){ var g=f&&f.geometry; if(g&&g.type==='LineString'&&Array.isArray(g.coordinates)){ var latlngs=g.coordinates.map(function(c){ return [c[1],c[0]]; }); var layer=L.polyline(latlngs,{ pane:'railwaysPane', color:'#666666', weight:1.5, opacity:0.9, dashArray:'4,6' }); railwayLayers.push(layer); } }); return true; }).catch(function(){ return false; }); }
    function addLocalityBoundariesLaPlata(){ if(Array.isArray(cachedLocalitiesLP)){ cachedLocalitiesLP.forEach(function(f){ var g=f&&f.geometry; if(!g) return; if(isPolygonGeojson(g)){ var glow=L.geoJSON(g,{ pane:'localitiesGlowPane', color:'#00aaff', weight:10, opacity:0.08, fill:false }); var sharp=L.geoJSON(g,{ pane:'localitiesPane', color:'#00aaff', weight:2, opacity:0.9, fill:false, dashArray:'6,4' }); localityLayers.push(glow); localityLayers.push(sharp); if(!boundariesHidden){ glow.addTo(map); sharp.addTo(map); try{ glow.bringToFront(); sharp.bringToFront(); }catch(e){} } } else if(g.type==='LineString' && Array.isArray(g.coordinates)){ var latlngs=g.coordinates.map(function(c){ return [c[1],c[0]]; }); var line=L.polyline(latlngs,{ pane:'localitiesPane', color:'#00aaff', weight:2, opacity:0.9, dashArray:'6,4' }); localityLayers.push(line); if(!boundariesHidden){ line.addTo(map); try{ line.bringToFront(); }catch(e){} } } }); return Promise.resolve(true); }
      return fetch('localidades_la_plata.geojson', { cache:'force-cache' }).then(function(r){ if(!r||!r.ok) return false; return r.json(); }).then(function(gj){ var feats=Array.isArray(gj.features)?gj.features:[]; feats.forEach(function(f){ var g=f&&f.geometry; if(!g) return; if(isPolygonGeojson(g)){ var glow=L.geoJSON(g,{ pane:'localitiesGlowPane', color:'#00aaff', weight:10, opacity:0.08, fill:false }); var sharp=L.geoJSON(g,{ pane:'localitiesPane', color:'#00aaff', weight:2, opacity:0.9, fill:false, dashArray:'6,4' }); localityLayers.push(glow); localityLayers.push(sharp); if(!boundariesHidden){ glow.addTo(map); sharp.addTo(map); try{ glow.bringToFront(); sharp.bringToFront(); }catch(e){} } } else if(g.type==='LineString' && Array.isArray(g.coordinates)){ var latlngs=g.coordinates.map(function(c){ return [c[1],c[0]]; }); var line=L.polyline(latlngs,{ pane:'localitiesPane', color:'#00aaff', weight:2, opacity:0.9, dashArray:'6,4' }); localityLayers.push(line); if(!boundariesHidden){ line.addTo(map); try{ line.bringToFront(); }catch(e){} } } }); cachedLocalitiesLP=feats; return true; }).catch(function(){ return false; }); }
    function updateDisplayForSelectedDistrict(){ try{ clearBoundaryLayers(); clearLocalityLayers(); if(boundariesHidden){ railwayLayers.forEach(function(l){ try{ map.removeLayer(l); }catch(e){} }); return; } var dist=(distritoSelect&&distritoSelect.value)||''; var distKey=(dist||'').trim().toLowerCase(); if(!distKey){ Object.keys(municipioGeomByName).forEach(function(k){ addBoundaryGeoJSON(municipioGeomByName[k]); }); railwayLayers.forEach(function(l){ try{ map.removeLayer(l); }catch(e){} }); } else if(distKey==='la plata'){ if(municipioGeomByName['la plata']) addBoundaryGeoJSON(municipioGeomByName['la plata']); railwayLayers.forEach(function(l){ try{ l.addTo(map); }catch(e){} }); addLocalityBoundariesLaPlata(); } else if(distKey==='berisso'){ if(municipioGeomByName['berisso']) addBoundaryGeoJSON(municipioGeomByName['berisso']); railwayLayers.forEach(function(l){ try{ map.removeLayer(l); }catch(e){} }); } else if(distKey==='ensenada'){ if(municipioGeomByName['ensenada']) addBoundaryGeoJSON(municipioGeomByName['ensenada']); railwayLayers.forEach(function(l){ try{ map.removeLayer(l); }catch(e){} }); } }catch(e){} }
    fetch('https://ema4k789-coder.github.io/MapaLaRaiz/camposfiltrados.geojson').then(function(r){ return r.ok?r.text():Promise.resolve('{}'); }).then(function(text){ var data; try{ data=JSON.parse(text); }catch(_){ data={ features:[] }; } if(!data||!data.features) data={ features:[] }; var todas=data.features.map(function(f){ var p=f.properties||{}; var hasGeom=f.geometry&&Array.isArray(f.geometry.coordinates); var lat=hasGeom?Number(f.geometry.coordinates[1]):Number(p.latitud||p.lat||p.latitude); var lng=hasGeom?Number(f.geometry.coordinates[0]):Number(p.longitud||p.lng||p.longitude); if(isNaN(lat)||isNaN(lng)){ var canon=normalizeLocalidadName(p.localidad||''); lat=-34.92; lng=-57.95; } f.geometry={ type:'Point', coordinates:[lng,lat] }; p._lat=lat; p._lng=lng; p.localidad_norm=normalizeLocalidadName(p.localidad||''); f.properties=p; return f; }); poiFeatures=todas.filter(function(f){ return (f.properties&&f.properties.tipo_lugar||'')==='lugar_interes_docente'; }); allSchools=todas.filter(function(f){ return (f.properties&&f.properties.tipo_lugar||'')!=='lugar_interes_docente'; });
      var nivelesUnicos = Array.from(new Set(allSchools.map(function(e){ return (e.properties&&e.properties.nivel||'').trim(); }))).filter(function(n){ return n; });
      function normStr(s){ return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim().toLowerCase(); }
      var nivelesLower = new Set(nivelesUnicos.map(function(n){ return normStr(n); }));
      var nivelesFiltrados = nivelesUnicos.filter(function(n){ var nn=normStr(n); if(nn.includes('psicologia comunitaria y pedagogia social')) return false; return nn!=='ciclo medio' && nn!=='centro de educacion agricola' && nn!=='centro de educacion agraria' && nn!=='agraria' && nn!=='modalidad: psicologia comunitaria y pedagogia social' && nn!=='nivenl secundario'; });
      if(!nivelesLower.has(normStr('Art√≠stica'))) nivelesFiltrados.push('Art√≠stica');
      if(!nivelesLower.has(normStr('T√©cnicas y Agrarias'))) nivelesFiltrados.push('T√©cnicas y Agrarias');
      if(!nivelesLower.has(normStr('ADULTOS'))) nivelesFiltrados.push('ADULTOS');
      if(!nivelesLower.has(normStr('JARDIN MATERNAL'))) nivelesFiltrados.push('JARDIN MATERNAL');
      var orden = ['NIVEL INICIAL','JARDIN MATERNAL','NIVEL PRIMARIO','NIVEL SECUNDARIO','T√âCNICAS Y AGRARIAS','ART√çSTICA','FORMACI√ìN INTEGRAL','ADULTOS','EDUCACI√ìN F√çSICA (C.E.F.)','NIVEL SUPERIOR','FORMACI√ìN PROFESIONAL'];
      var ordenMap = new Map(orden.map(function(n,i){ return [normStr(n), i]; }));
      nivelesFiltrados.sort(function(a,b){ var ia=ordenMap.has(normStr(a))?ordenMap.get(normStr(a)):Number.MAX_SAFE_INTEGER; var ib=ordenMap.has(normStr(b))?ordenMap.get(normStr(b)):Number.MAX_SAFE_INTEGER; if(ia!==ib) return ia-ib; return normStr(a).localeCompare(normStr(b)); });
      var panelContent=document.getElementById('panelContent'); panelContent.innerHTML='';
      var allLabel=document.createElement('label'); allLabel.className='levels-all'; var allCb=document.createElement('input'); allCb.type='checkbox'; allCb.id='levelAll'; allCb.checked=false; allLabel.appendChild(allCb); allLabel.appendChild(document.createTextNode(' Todos los niveles')); panelContent.appendChild(allLabel);
      nivelesFiltrados.forEach(function(nivel){ var label=document.createElement('label'); var cb=document.createElement('input'); cb.type='checkbox'; cb.className='levelCheck'; cb.value=nivel; cb.checked=false; var color=getColorByLevel(nivel); label.style.borderLeft='12px solid '+color; label.style.paddingLeft='8px'; label.appendChild(cb); var normNivel=normStr(nivel); var displayName=(normNivel===normStr('PLAN FINES (TRAYECTOS Y DEUDORES)'))?'CENS':nivel.toUpperCase(); label.appendChild(document.createTextNode(' '+displayName)); panelContent.appendChild(label); });
      var scrollHint=document.createElement('div'); scrollHint.className='panel-scroll-hint'; scrollHint.innerHTML='Deslizar para ver m√°s niveles <span class=\"panel-scroll-hint-icon\">‚¨á‚¨á</span>'; panelContent.appendChild(scrollHint);
      levelAll=document.getElementById('levelAll'); levelChecks=Array.from(document.querySelectorAll('.levelCheck'));
      if(levelAll){ levelAll.addEventListener('change', function(){ var v=levelAll.checked; levelChecks.forEach(function(cb){ cb.checked=v; }); filterSchools(); updateLevelsBadgeCount(); }); }
      levelChecks.forEach(function(cb){ cb.addEventListener('change', function(e){ e.stopPropagation(); if(!cb.checked){ if(levelAll) levelAll.checked=false; } else if(levelAll && levelChecks.every(function(c){ return c.checked; })){ levelAll.checked=true; } filterSchools(); updateLevelsBadgeCount(); }); });
      populateLocalities(); renderMarkers([]); updateLevelsBadgeCount(); filterSchools(); tryLoadMunicipalBoundaries().then(function(ok){ if(ok){ try{ var fc={ type:'FeatureCollection', features:[] }; ['la plata','berisso','ensenada'].forEach(function(n){ var g=municipioGeomByName[n]; if(g){ fc.features.push({ type:'Feature', geometry:g }); } }); }catch(e){} } }); tryLoadLocalBoundaryLines().then(function(){ updateDisplayForSelectedDistrict(); }); applyPanelPosition(); });
    function applyPanelPosition(){ var panel=document.getElementById('filterLevelPanel'); var content=document.getElementById('panelContent'); var topbar=document.getElementById('topbar'); var admin=document.getElementById('admin-panel'); if(!panel) return; var th= topbar ? topbar.offsetHeight : 0; var adminVisible = admin && window.getComputedStyle(admin).display !== 'none'; var ah= adminVisible ? (admin.offsetHeight || 0) : 0; var offset = (th + ah + 8); panel.style.top = offset + 'px'; var vh = window.innerHeight || document.documentElement.clientHeight || 768; var maxPanelH = Math.max(140, vh - offset - 12); panel.style.maxHeight = maxPanelH + 'px'; if(content){ var header = document.getElementById('panelHeader'); var resizer = document.getElementById('panelResizer'); var headerH = header ? header.offsetHeight : 0; var resizerH = resizer ? resizer.offsetHeight : 0; var contentMax = Math.max(80, maxPanelH - headerH - resizerH - 24); content.style.maxHeight = contentMax + 'px'; content.style.overflowY = 'auto'; } try{ document.documentElement.style.setProperty('--controls-top', offset + 'px'); }catch(e){} }
    (function(){ var btn=document.getElementById('togglePanelBtn'); var content=document.getElementById('panelContent'); var panel=document.getElementById('filterLevelPanel'); var levelsBtn=document.getElementById('levelsHeaderBtn'); function openLevelsPanel(){ if(panel) panel.classList.remove('collapsed'); if(content) content.classList.remove('hidden'); applyPanelPosition(); } function closeLevelsPanel(){ if(content) content.classList.add('hidden'); if(panel) panel.classList.add('collapsed'); } function toggleLevelsPanel(){ 
      var isClosed = !panel || panel.classList.contains('collapsed') || (content && content.classList.contains('hidden')); 
      // Cerrar popups antes de abrir panel
      if(isClosed && window.map && window.map.eachLayer) {
        window.map.eachLayer(function(layer) {
          if(layer.getPopup && layer.getPopup() && layer.getPopup().isOpen && layer.getPopup().isOpen()) {
            window.map.closePopup(layer.getPopup());
          }
        });
      }
      if(isClosed){ 
        openLevelsPanel(); 
      } else { 
        closeLevelsPanel(); 
      } 
    } if(btn){ btn.addEventListener('click', toggleLevelsPanel); } if(levelsBtn){ levelsBtn.addEventListener('click', toggleLevelsPanel); } var filtersBtn=document.getElementById('filtersHeaderBtn'); var filtersTopBtn=document.getElementById('filtersBtn'); var admin=document.getElementById('admin-panel'); function updateFiltersText(){ if(!filtersTopBtn||!admin) return; var visible = window.getComputedStyle(admin).display !== 'none'; filtersTopBtn.textContent = visible ? 'OCULTAR MEN√ö' : 'VER MEN√ö'; if(visible){ filtersTopBtn.classList.add('is-hide'); } else { filtersTopBtn.classList.remove('is-hide'); } } function toggleAdmin(){ 
      if(!admin) return; 
      // Cerrar todos los popups abiertos antes de abrir/cerrar men√∫
      if(window.map && window.map.eachLayer) {
        window.map.eachLayer(function(layer) {
          if(layer.getPopup && layer.getPopup() && layer.getPopup().isOpen && layer.getPopup().isOpen()) {
            window.map.closePopup(layer.getPopup());
          }
        });
      }
      var isVisible = window.getComputedStyle(admin).display !== 'none';
      window.adminPanelOpen = !isVisible;
      admin.style.display = isVisible ? 'none' : ''; 
      closeLevelsPanel(); 
      applyPanelPosition(); 
      updateFiltersText(); 
    } if(filtersBtn){ filtersBtn.addEventListener('click', toggleAdmin); } if(filtersTopBtn){ filtersTopBtn.addEventListener('click', toggleAdmin); } var toggleBoundariesBtn=document.getElementById('toggleBoundariesVisibilityBtn'); if(toggleBoundariesBtn){ toggleBoundariesBtn.addEventListener('click', function(){ setBoundariesHidden(!boundariesHidden); }); } window.addEventListener('resize', applyPanelPosition); document.getElementById('startBtn').addEventListener('click', function(){ applyPanelPosition(); closeLevelsPanel(); updateFiltersText(); }); updateFiltersText(); })();
    window.wirePopupInteractions = function(root,p,isOverlay){
      if(!root) return;
      var frame=root.querySelector('.popup-frame');
      var imgEl=root.querySelector('.frame-img');
      if(frame && imgEl){
        imgEl.onerror=function(){ try{ imgEl.remove(); }catch(e){} };
        if(window.getFrameURL){
          window.getFrameURL().then(function(url){ if(url) imgEl.src=url; });
        }
      }
      var dlBtn=root.querySelector('.popup-dl-btn');
      if(dlBtn){
        dlBtn.onclick = async function(ev){
          ev.stopPropagation();
          var targetFrame=root.querySelector('.popup-frame');
          if(!targetFrame || typeof html2canvas==='undefined') return;
          var fc=targetFrame.querySelector('.frame-content');
          if(!fc) return;
          var isMobile=((window.innerWidth||1024)<=600)||(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent));
          var scaleVal=isMobile?1.25:2;
          var originalScroll=fc.scrollTop||0;
          fc.scrollTop=0;
          var visibleCanvas=await html2canvas(targetFrame,{ backgroundColor:null, useCORS:true, scale:scaleVal });
          var hiddenCanvas=null;
          if(fc.scrollHeight>fc.clientHeight){
            var saltoScroll=fc.clientHeight;
            var ultimoCompleto2=null;
            Array.prototype.forEach.call(fc.children,function(child){
              var childBottom=child.offsetTop+child.offsetHeight;
              if(childBottom <= fc.clientHeight){
                ultimoCompleto2=child;
              }
            });
            if(ultimoCompleto2){
              saltoScroll=ultimoCompleto2.offsetTop+ultimoCompleto2.offsetHeight;
            }
            fc.scrollTop=saltoScroll;
            hiddenCanvas=await html2canvas(targetFrame,{ backgroundColor:null, useCORS:true, scale:scaleVal });
          } else {
            hiddenCanvas=visibleCanvas;
          }
          fc.scrollTop=originalScroll;
          var piz=new Image();
          piz.onload=function(){
            var width=piz.width;
            var height=piz.height;
            var totalWidth=hiddenCanvas ? width*2 : width;
            var finalCanvas=document.createElement('canvas');
            finalCanvas.width=totalWidth;
            finalCanvas.height=height;
            var ctx=finalCanvas.getContext('2d');
            ctx.drawImage(piz,0,0,width,height);
            ctx.drawImage(visibleCanvas,0,0,width,height);
            if(hiddenCanvas){
              ctx.drawImage(piz,width,0,width,height);
              ctx.drawImage(hiddenCanvas,width,0,width,height);
            }
            var fname=String(p && p.nombre ||'escuela').replace(/[^a-z0-9 -]/gi,'_');
            if(!fname) fname='escuela';
            fname += hiddenCanvas ? '_doble.jpg' : '.jpg';
            finalCanvas.toBlob(function(blob){
              if(!blob) return;
              var url=URL.createObjectURL(blob);
              var ua=(navigator&&navigator.userAgent)||'';
              var isIOS=/iPhone|iPad|iPod/i.test(ua);
              if(isIOS){
                try{ window.open(url,'_blank'); }catch(e){}
                setTimeout(function(){ try{ URL.revokeObjectURL(url); }catch(e){} },5000);
              } else {
                var a=document.createElement('a');
                a.href=url;
                a.download=fname;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
              }
            },'image/jpeg',0.92);
          };
          piz.onerror=function(){
            var ancho=visibleCanvas.width;
            var alto=visibleCanvas.height;
            var finalCanvas=document.createElement('canvas');
            finalCanvas.width=ancho;
            finalCanvas.height=alto;
            var ctx=finalCanvas.getContext('2d');
            ctx.drawImage(visibleCanvas,0,0,ancho,alto);
            var fname=String(p && p.nombre ||'escuela').replace(/[^a-z0-9 -]/gi,'_')+'.jpg';
            finalCanvas.toBlob(function(blob){
              if(!blob) return;
              var url=URL.createObjectURL(blob);
              var ua=(navigator&&navigator.userAgent)||'';
              var isIOS=/iPhone|iPad|iPod/i.test(ua);
              if(isIOS){
                try{ window.open(url,'_blank'); }catch(e){}
                setTimeout(function(){ try{ URL.revokeObjectURL(url); }catch(e){} },5000);
              } else {
                var a=document.createElement('a');
                a.href=url;
                a.download=fname;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
              }
            },'image/jpeg',0.92);
          };
          piz.src=(targetFrame.querySelector('.frame-img') && targetFrame.querySelector('.frame-img').src) || 'pizarron.png';
        };
      }
      var mapBtn=root.querySelector('.popup-map-capture-btn');
      if(mapBtn){
        try{ mapBtn.parentNode.removeChild(mapBtn); }catch(e){}
      }
      var volverBtn=root.querySelector('.popup-volver-btn');
      if(volverBtn){
        volverBtn.onclick=function(ev){
          ev.stopPropagation();
          if(isOverlay){ hideSchoolOverlay(); } else { map.closePopup(); }
        };
      }
    };
  </script>
</body>
</html>
